# Ansible provisioning playbook
# Inspired by https://www.stavros.io/posts/provisioning-your-computer-one-command-awesome/

---
- name: Provision a machine
  hosts: 127.0.0.1
  connection: local
  gather_facts: yes
  tasks:

  - name: Install prerequisites
    apt: name={{ item }}
    become: yes
    with_items:
      - apt-transport-https
      - ca-certificates
      - curl
      - software-properties-common

  - name: Add Docker repository key
    apt_key: url=https://download.docker.com/linux/ubuntu/gpg
    become: yes

  - name: Add repositories
    apt_repository: repo='{{ item }}'
    register: ppa
    become: yes
    with_items:
      - 'deb [arch=amd64] https://download.docker.com/linux/ubuntu {{ ansible_distribution_release }} nightly'

  - name: Update package cache
    apt: update_cache=yes
    become: yes
    when: ppa.changed

  - name: Install packages
    apt: name={{ item }}
    become: yes
    with_items:
      - build-essential
      - chromium-browser
      - cowsay
      - emacs25-lucid
      - figlet
      - filezilla
      - firefox
      - fortunes
      - gdb
      - git
      - htop
      - irssi
      - keepassx
      - lolcat
      - minicom
      - php-cli
      - rofi
      - silversearcher-ag
      - stow
      - tmux
      - wireshark
      - vim-nox
      - zeal
      - zsh

  # You can use VDE to 'ease' network configuration of VMs on laptops.
  - name: Install KVM packages
    apt: name={{ item }}
    become: yes
    with_items:
      - bridge-utils
      - cpu-checker
      - libvirt-bin
      - qemu-kvm
      - uml-utilities
      - vde2

  - name: Install Docker packages
    apt: name={{ item }}
    become: yes
    with_items:
      - docker-ce # Enabled by the Docker repository above

  # Hopefully there's never a problem with getcomposer.org :/
  - name: Install Composer
    shell: curl -sS https://getcomposer.org/installer | php -- --install-dir=/usr/local/bin --filename=composer
    args:
      creates: /usr/local/bin/composer

  - name: Installation script
    shell: ~/Dotfiles/installation.sh

  - name: MATE configuration
    shell: ~/Dotfiles/mateconf.sh

  - name: Change shell to zsh
    become: yes
    user: name={{ ansible_user_id }} shell=/usr/bin/zsh groups=dialout,disk append=yes
